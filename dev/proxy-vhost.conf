<VirtualHost *:80>
    # Normalize // to / under /site2 and redirect /site2 -> /site2/
    # RewriteEngine On
    # Collapse accidental duplicate slashes after /site2/
    RewriteRule ^/site2//+(.*)$ /site2/$1 [R=301,L]

    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "http"

    ServerAdmin webmaster@localhost
    LogLevel warn
    ErrorLog  ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    # 0. SSI + filters for every /site2 request
    # <LocationMatch "^/site2(/|$)">
    #     Options +IncludesNoExec
    #     # run filters in order â†’ first SUBSTITUTE, then INCLUDES
    #     SetOutputFilter SUBSTITUTE;INCLUDES
    # </LocationMatch>

    # 1. Strip gzip early, advertise prefix, tidy cookies
    RequestHeader unset Accept-Encoding early
    # RequestHeader set  X-Forwarded-Prefix "/site2"
    ProxyPassReverseCookiePath "/" "/site2/"

    # 2. Reverse-proxy (slash and no-slash forms)
    ProxyPass        "/site2"  "http://host.docker.internal:8080/site2"
    ProxyPassReverse "/site2"  "http://host.docker.internal:8080/site2"
    ProxyPass        "/site2/" "http://host.docker.internal:8080/site2"
    ProxyPassReverse "/site2/" "http://host.docker.internal:8080/site2"

    # 3. Expose fragment files
    Alias "/partials/" "/var/www/partials/"
    <Directory "/var/www/partials">
        Options +IncludesNoExec
        Require all granted
    </Directory>

    # Substitute "s|</head>|<!--#include virtual='/partials/cw3e_head_bottom.html' --></head>|i"
    # Substitute "s|<body[^>]*>|$0<!--#include virtual='/partials/cw3e_header.html' -->|ni"
    # Substitute "s|</body>|<!--#include virtual='/partials/cw3e_body_bottom.html' --><!--#include virtual='/partials/cw3e_footer.html' --></body>|i"

    <LocationMatch "^/site2(/|$)">
        Options +IncludesNoExec
        # Order matters: first SUBSTITUTE, then INCLUDES
        SetOutputFilter SUBSTITUTE;INCLUDES

        # Make sure large chunks can be matched
        SubstituteMaxLineLength 10m

        # 1) Inject just before </head>
        Substitute "s|</head>|<!--#include virtual='/partials/cw3e_head_bottom.html' --></head>|i"

        # 2) Inject right after <body ...> (use a capture group; avoid $0)
        Substitute "s|(<body[^>]*>)|\1<!--#include virtual='/partials/cw3e_header.html' -->|i"

        # 3) Inject right before </body>
        Substitute "s|</body>|<!--#include virtual='/partials/cw3e_body_bottom.html' --><!--#include virtual='/partials/cw3e_footer.html' --></body>|i"
    </LocationMatch>


</VirtualHost>
