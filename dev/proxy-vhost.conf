<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    LogLevel warn
    ErrorLog  ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    # 0  Enable SSI for the proxied location
    <Location "/site2/">
        Options +IncludesNoExec
    </Location>

    # 1  Reverse proxy
    RequestHeader set X-Forwarded-Prefix "/site2"
    ProxyPass        "/site2/" "http://host.docker.internal:8080/"
    ProxyPassReverse "/site2/" "http://host.docker.internal:8080/"
    RequestHeader unset Accept-Encoding

    # 2  Static fragments
    Alias "/partials/" "/var/www/partials/"
    <Directory "/var/www/partials">
        Options +IncludesNoExec
        Require all granted
    </Directory>

    # 3  Injection filters
    AddOutputFilterByType SUBSTITUTE text/html
    AddOutputFilterByType INCLUDES   text/html

    Substitute "s|</head>|<!--#include virtual='/partials/cw3e_head_bottom.html' --></head>|i"
    Substitute "s|<body[^>]*>|$0<!--#include virtual='/partials/cw3e_header.html' -->|ni"
    Substitute "s|</body>|<!--#include virtual='/partials/cw3e_body_bottom.html' --><!--#include virtual='/partials/cw3e_footer.html' --></body>|i"
</VirtualHost>
